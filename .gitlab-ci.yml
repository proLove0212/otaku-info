stages:
  - test
  - stats
  - release
  - deploy

stylecheck:
  stage: test
  tags:
    - python3
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - python-codestyle-check

unittest:
  stage: test
  tags:
    - python3
    - progstats
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - python-unittest

release_upload:
  stage: release
  only:
    - master
  tags:
    - python3
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - github-release-upload $(cat version) "$(changelog-reader)"
    - gitlab-release-upload $(cat version) "$(changelog-reader)"

pypi_upload:
  stage: release
  only:
    - master
  tags:
    - python3
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - pypi-upload

deploy_bot:
  stage: deploy
  only:
    - master
    - develop
  tags:
    - python3
  script:
    - mkdir -p ~/.config/bots
    - mkdir -p ~/.config/otaku_info_bot
    - mkdir -p ~/.config/systemd/user
    - rm -rf ~/.config/bots/otaku_info_bot
    - rm -f ~/.config/systemd/user/otaku_info_bot.service
    - python3 -m venv ~/.config/bots/otaku_info_bot
    - source ~/.config/bots/otaku_info_bot/bin/activate
    - python setup.py install
    - echo $TELEGRAM_SETTINGS > ~/.config/otaku_info_bot/settings.json
    - echo "[Unit]" >> ~/.config/systemd/user/otaku_info_bot.service
    - echo "Description=otaku_info_bot" >> ~/.config/systemd/user/otaku_info_bot.service
    - echo "[Service]" >> ~/.config/systemd/user/otaku_info_bot.service
    - echo "ExecStart=$HOME/.config/bots/otaku_info_bot/bin/otaku_info_bot" >> ~/.config/systemd/user/otaku_info_bot.service
    - echo "[Install]" >> ~/.config/systemd/user/otaku_info_bot.service
    - echo "WantedBy=default.target" >> ~/.config/systemd/user/otaku_info_bot.service
    - systemctl --user daemon-reload
    - systemctl --user restart otaku_info_bot.service

gitstats:
  stage: stats
  tags:
    - python3
    - gitstats
    - progstats
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - gitstats-gen

docgen:
  stage: stats
  tags:
    - python3
    - progstats
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - sphinx-docgen
